# 🔍 网络请求问题排查指南

## 问题：request:fail timeout

### 可能原因

1. **微信开发者工具网络配置**
   - 小程序无法直接访问局域网 IP
   - 需要使用 `localhost` 或配置代理

2. **超时时间不足**
   - AI 处理可能需要 30-60 秒
   - 默认超时时间可能不够

3. **防火墙或网络限制**
   - macOS 防火墙可能阻止连接
   - 网络配置问题

## ✅ 解决方案

### 方案 1：使用 localhost（推荐，适用于开发者工具）

微信开发者工具支持访问 `localhost`，已更新代码使用：
```typescript
const API_URL = 'http://localhost:5001'
```

### 方案 2：配置微信开发者工具

1. 打开微信开发者工具
2. 点击右上角"详情"
3. 在"本地设置"中：
   - ✅ **必须勾选**："不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   - ✅ **必须勾选**："不校验安全域名"

### 方案 3：真机调试（使用局域网 IP）

如果需要在真机上测试：

1. **获取您的局域网 IP**
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```

2. **修改代码中的 API_URL**
   ```typescript
   const API_URL = 'http://YOUR_IP:5001'
   ```

3. **确保手机和电脑在同一网络**

4. **检查防火墙**
   - macOS：系统偏好设置 → 安全性与隐私 → 防火墙
   - 允许 Python 或端口 5001 的连接

### 方案 4：增加超时时间

已更新超时时间为 60 秒：
```typescript
timeout: 60000 // 60 秒
```

## 🧪 测试步骤

### 1. 检查 API 服务
```bash
curl http://localhost:5001/health
```

应该返回：
```json
{"status": "ok", "message": "AI 采集服务运行中"}
```

### 2. 测试 POST 请求
```bash
curl -X POST http://localhost:5001/api/ingest \
  -H "Content-Type: application/json" \
  -d '{"content":"测试","type":"text"}'
```

### 3. 在小程序中测试

1. 确保微信开发者工具的本地设置已正确配置
2. 打开"智能识别助手"
3. 输入测试文本
4. 点击"开始 AI 识别"
5. 查看控制台是否有错误

## 🔍 调试技巧

### 查看详细错误信息

在小程序代码中添加更多日志：
```typescript
console.log('📡 API URL:', API_URL)
console.log('📡 请求数据:', data)
console.log('📡 响应:', response)
```

### 检查网络请求

1. 打开微信开发者工具
2. 切换到"Network"标签
3. 查看请求详情：
   - 请求 URL
   - 请求状态
   - 响应内容
   - 错误信息

## ⚠️ 常见问题

### Q: 仍然超时？
A: 
1. 检查 API 服务是否正在运行
2. 检查超时时间是否足够（已设置为 60 秒）
3. 检查网络连接
4. 查看 API 服务日志，确认是否收到请求

### Q: 真机无法连接？
A:
1. 确保手机和电脑在同一 WiFi 网络
2. 检查防火墙设置
3. 使用局域网 IP 而不是 localhost
4. 确保 API 服务监听 `0.0.0.0`（已配置）

### Q: 如何查看 API 服务日志？
A:
```bash
# 前台运行查看日志
cd scripts
python3 api_server.py
```

## 📝 当前配置

- **开发环境（开发者工具）**：`http://localhost:5001`
- **真机调试**：`http://192.168.1.12:5001`（需要根据实际 IP 修改）
- **超时时间**：60 秒

---

**提示**：如果问题仍然存在，请检查微信开发者工具的"本地设置"，确保已勾选所有必要的选项。








