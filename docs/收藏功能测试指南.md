# 收藏功能测试指南

## 📋 测试前准备

### 1. 确认数据库已设置

确保你已经在 Supabase 中执行了以下操作：

- ✅ 执行了 `scripts/create_favorites_tables_simple.sql`
- ✅ users 表已创建
- ✅ favorites 表已创建
- ✅ RLS 策略已配置

**验证方法**：
```sql
-- 在 Supabase SQL Editor 中执行
SELECT * FROM users LIMIT 1;
SELECT * FROM favorites LIMIT 1;
```

如果没有报错，说明表已创建成功。

### 2. 确认小程序已编译

```bash
# 在项目根目录执行
npm run dev:weapp
```

### 3. 打开微信开发者工具

1. 打开微信开发者工具
2. 选择项目目录：`dist/`
3. 确保勾选了"不校验合法域名"（详情 → 本地设置）

---

## 🧪 测试步骤

### 测试 1: 用户认证（AuthService）

**目标**：验证用户能够自动获取 OpenID

**步骤**：
1. 打开小程序
2. 打开控制台（Console）
3. 查找日志：`[AuthService] 生成临时 OpenID: temp_xxxxxxxx`

**预期结果**：
- ✅ 控制台显示 OpenID 已生成
- ✅ 没有报错

**如果失败**：
- 检查 `src/services/auth.ts` 是否正确导入
- 查看控制台错误信息

---

### 测试 2: 首页加载收藏状态

**目标**：验证首页能够批量查询收藏状态

**步骤**：
1. 确保首页有活动数据（如果没有，使用 Mock 数据）
2. 打开控制台
3. 查找日志：`[FavoritesService] 批量查询收藏状态`

**预期结果**：
- ✅ 每个活动卡片右上角显示心形图标（🤍）
- ✅ 没有报错

**如果失败**：
- 检查 `src/components/FavoriteButton/index.tsx` 是否正确导入
- 检查控制台是否有网络错误

---

### 测试 3: 点击收藏按钮

**目标**：验证收藏功能正常工作

**步骤**：
1. 在首页找到任意一个活动卡片
2. 点击右上角的心形图标（🤍）
3. 观察变化

**预期结果**：
- ✅ 心形图标立即变为实心（❤️）
- ✅ 显示 Toast 提示："已收藏"
- ✅ 图标有心跳动画效果

**如果失败**：
- 打开控制台查看错误信息
- 检查是否是认证问题（未获取到 OpenID）
- 检查 Supabase 连接是否正常

---

### 测试 4: 取消收藏

**目标**：验证取消收藏功能

**步骤**：
1. 点击已收藏的活动（❤️）
2. 再次点击心形图标
3. 观察变化

**预期结果**：
- ✅ 心形图标变回空心（🤍）
- ✅ 显示 Toast 提示："已取消收藏"

---

### 测试 5: 收藏状态持久化

**目标**：验证收藏数据保存到数据库

**步骤**：
1. 收藏一个活动
2. 在 Supabase SQL Editor 中执行：
```sql
SELECT * FROM favorites ORDER BY created_at DESC LIMIT 5;
```

**预期结果**：
- ✅ 能看到刚才收藏的记录
- ✅ user_id 和 event_id 正确

**如果失败**：
- 检查 RLS 策略是否正确配置
- 检查 Supabase API Key 是否正确

---

### 测试 6: 刷新页面后状态保持

**目标**：验证收藏状态在刷新后保持

**步骤**：
1. 收藏几个活动
2. 刷新小程序（重新编译或重启）
3. 观察收藏状态

**预期结果**：
- ✅ 之前收藏的活动仍然显示为已收藏（❤️）
- ✅ OpenID 从本地存储加载

---

### 测试 7: 详情页收藏按钮

**目标**：验证详情页的收藏功能

**步骤**：
1. 点击任意活动卡片进入详情页
2. 点击顶部的心形图标（大尺寸）
3. 返回首页

**预期结果**：
- ✅ 详情页的收藏状态正确显示
- ✅ 点击后状态正确切换
- ✅ 返回首页后，该活动的收藏状态已同步

---

### 测试 8: 幂等性测试

**目标**：验证重复收藏不会报错

**步骤**：
1. 收藏一个活动
2. 快速连续点击收藏按钮多次

**预期结果**：
- ✅ 不会报错
- ✅ 最终状态正确（已收藏）
- ✅ 数据库中没有重复记录

---

### 测试 9: 网络错误处理

**目标**：验证网络错误时的处理

**步骤**：
1. 在微信开发者工具中，打开"Network" 面板
2. 勾选"Offline"（模拟离线）
3. 尝试收藏一个活动

**预期结果**：
- ✅ 显示 Toast："收藏失败，请检查网络连接"
- ✅ 收藏状态回滚（仍然是未收藏）

---

### 测试 10: 批量查询性能

**目标**：验证批量查询的性能

**步骤**：
1. 确保首页有至少 10 个活动
2. 打开 Network 面板
3. 刷新页面
4. 查看网络请求

**预期结果**：
- ✅ 只有一次查询收藏状态的请求（批量查询）
- ✅ 不是 10 次单独的请求

---

## 🐛 常见问题排查

### 问题 1: 点击收藏按钮没有反应

**可能原因**：
1. OpenID 未获取成功
2. Supabase 连接失败
3. RLS 策略配置错误

**排查步骤**：
```javascript
// 在控制台执行
import authService from './services/auth'
const openid = await authService.getOpenID()
console.log('OpenID:', openid)
```

### 问题 2: 收藏后刷新页面状态丢失

**可能原因**：
1. 数据没有保存到数据库
2. 批量查询失败

**排查步骤**：
```sql
-- 在 Supabase SQL Editor 中执行
SELECT * FROM favorites WHERE user_id = 'temp_xxxxxxxx';
```

### 问题 3: Toast 提示不显示

**可能原因**：
1. FavoritesService 的 Toast 被其他代码覆盖
2. Taro.showToast 配置问题

**排查步骤**：
- 检查控制台是否有错误
- 确认 `src/services/favorites.ts` 中的 Toast 代码正确

### 问题 4: 心跳动画不流畅

**可能原因**：
1. CSS 动画被覆盖
2. 性能问题

**排查步骤**：
- 检查 `src/components/FavoriteButton/index.scss` 是否正确加载
- 使用浏览器开发者工具检查 CSS

---

## 📊 测试检查清单

完成以下所有测试后，打勾确认：

- [ ] 测试 1: 用户认证成功
- [ ] 测试 2: 首页加载收藏状态
- [ ] 测试 3: 点击收藏按钮
- [ ] 测试 4: 取消收藏
- [ ] 测试 5: 收藏状态持久化
- [ ] 测试 6: 刷新页面后状态保持
- [ ] 测试 7: 详情页收藏按钮
- [ ] 测试 8: 幂等性测试
- [ ] 测试 9: 网络错误处理
- [ ] 测试 10: 批量查询性能

---

## 🎯 下一步

如果所有测试都通过：
- ✅ 收藏功能核心部分已完成
- ✅ 可以继续开发个人中心和收藏列表页面

如果有测试失败：
- 📝 记录失败的测试和错误信息
- 🔍 根据排查步骤定位问题
- 💬 向开发者反馈问题

---

## 📞 获取帮助

如果遇到问题，请提供以下信息：

1. **失败的测试编号**
2. **控制台错误信息**（截图或复制文本）
3. **Network 面板的请求详情**
4. **Supabase 数据库查询结果**

这些信息将帮助快速定位和解决问题。

---

**测试愉快！** 🎉
