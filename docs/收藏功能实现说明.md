# ❤️ 收藏功能实现说明

## ✅ 已完成功能

### 1. 数据库表
- ✅ `users` 表：存储用户 OpenID
- ✅ `favorites` 表：存储收藏关系
- ✅ `view_history` 表：存储浏览历史

### 2. API 函数（`supabase-rest.ts`）

- ✅ `getWechatOpenID()` - 获取微信用户 OpenID
- ✅ `upsertUser(openid)` - 创建或更新用户记录
- ✅ `addFavorite(userId, eventId)` - 添加收藏
- ✅ `removeFavorite(userId, eventId)` - 取消收藏
- ✅ `checkFavorite(userId, eventId)` - 检查收藏状态
- ✅ `getFavorites(userId)` - 获取收藏列表
- ✅ `recordViewHistory(userId, eventId)` - 记录浏览历史
- ✅ `getViewHistory(userId)` - 获取浏览历史

### 3. 前端功能（`index.tsx`）

- ✅ 用户初始化：页面加载时自动获取 OpenID
- ✅ 收藏按钮：点击心形按钮收藏/取消收藏
- ✅ 收藏状态：自动加载并显示收藏状态
- ✅ 个人中心：显示收藏列表和浏览足迹
- ✅ 浏览记录：打开详情页时自动记录

---

## 🔧 使用说明

### 用户流程

1. **首次使用**：
   - 打开小程序，自动获取微信 OpenID
   - 自动创建用户记录

2. **收藏操作**：
   - 在首页或详情页点击 ❤️ 按钮
   - 自动保存到数据库
   - 显示 Toast 提示

3. **查看收藏**：
   - 切换到"我的"标签
   - 查看"我的收藏"列表
   - 点击可查看详情

4. **浏览历史**：
   - 自动记录最近浏览的 20 条
   - 在个人中心查看

---

## ⚠️ 注意事项

### OpenID 获取

当前使用**临时方案**：
- 使用微信 `login()` 获取 code
- 使用 code 的前 16 位作为临时用户 ID

**生产环境必须**：
- 将 code 发送到后端服务器
- 后端调用微信 API 换取真实的 openid
- 返回 openid 给小程序

### 数据库表

**必须先执行**：
```sql
-- 在 Supabase SQL Editor 中执行
-- supabase_schema_users.sql
```

---

## 🐛 故障排查

### 收藏功能不工作

1. **检查数据库表**：
   ```sql
   SELECT * FROM users LIMIT 1;
   SELECT * FROM favorites LIMIT 1;
   ```

2. **检查 RLS 策略**：
   ```sql
   SELECT * FROM pg_policies WHERE tablename IN ('users', 'favorites');
   ```

3. **检查控制台日志**：
   - 打开微信开发者工具
   - 查看 Console 输出
   - 查找错误信息

### 用户 ID 为 null

- 检查微信登录权限
- 确认小程序已配置 AppID
- 查看控制台是否有错误

---

## 📝 后续优化

- [ ] 实现真实的 OpenID 获取（后端接口）
- [ ] 添加收藏同步（多设备）
- [ ] 优化加载性能（批量查询）
- [ ] 添加收藏分类功能

---

**最后更新**：2025年12月4日








