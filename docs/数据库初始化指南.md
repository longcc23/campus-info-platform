# ğŸ“Š æ•°æ®åº“åˆå§‹åŒ–æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•åœ¨ Supabase ä¸­åˆå§‹åŒ–æ•°æ®åº“è¡¨ã€‚

---

## ğŸ“‹ æ‰§è¡Œé¡ºåº

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸»è¡¨ï¼ˆEventsï¼‰

1. æ‰“å¼€ Supabase æ§åˆ¶å°
2. è¿›å…¥ **SQL Editor**
3. å¤åˆ¶ `supabase_schema.sql` çš„å…¨éƒ¨å†…å®¹
4. ç²˜è´´åˆ° SQL Editor
5. ç‚¹å‡» **Run** æ‰§è¡Œ

**éªŒè¯**ï¼š
```sql
SELECT * FROM events LIMIT 1;
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç”¨æˆ·ç›¸å…³è¡¨ï¼ˆUsers, Favorites, View Historyï¼‰

1. åœ¨åŒä¸€ä¸ª SQL Editor ä¸­
2. å¤åˆ¶ `supabase_schema_users.sql` çš„å…¨éƒ¨å†…å®¹
3. ç²˜è´´åˆ° SQL Editor
4. ç‚¹å‡» **Run** æ‰§è¡Œ

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('users', 'favorites', 'view_history');

-- åº”è¯¥è¿”å› 3 è¡Œ
```

---

## ğŸ” æ‰§è¡Œåçš„éªŒè¯

### æ£€æŸ¥æ‰€æœ‰è¡¨

```sql
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns 
     WHERE table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

**é¢„æœŸç»“æœ**ï¼š
- `events` - ä¸»è¡¨
- `favorites` - æ”¶è—è¡¨
- `users` - ç”¨æˆ·è¡¨
- `view_history` - æµè§ˆè¶³è¿¹è¡¨

### æ£€æŸ¥ RLS ç­–ç•¥

```sql
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

### æ£€æŸ¥ç´¢å¼•

```sql
SELECT 
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. å¤–é”®çº¦æŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`relation "events" does not exist`

**åŸå› **ï¼šå…ˆæ‰§è¡Œäº† `supabase_schema_users.sql`ï¼Œä½† `events` è¡¨è¿˜æœªåˆ›å»º

**è§£å†³**ï¼šå…ˆæ‰§è¡Œ `supabase_schema.sql`ï¼Œå†æ‰§è¡Œ `supabase_schema_users.sql`

### 2. ç­–ç•¥å·²å­˜åœ¨é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`policy "Allow public read access on users" already exists`

**åŸå› **ï¼šé‡å¤æ‰§è¡Œäº† SQL è„šæœ¬

**è§£å†³**ï¼šå¯ä»¥å¿½ç•¥ï¼Œæˆ–å…ˆåˆ é™¤ç­–ç•¥å†æ‰§è¡Œï¼š
```sql
DROP POLICY IF EXISTS "Allow public read access on users" ON users;
```

### 3. è§¦å‘å™¨å‡½æ•°å·²å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š`function cleanup_old_view_history() already exists`

**è§£å†³**ï¼šè„šæœ¬ä¸­å·²ä½¿ç”¨ `CREATE OR REPLACE FUNCTION`ï¼Œå¯ä»¥å®‰å…¨é‡å¤æ‰§è¡Œ

---

## ğŸ“ å¿«é€Ÿæ‰§è¡Œè„šæœ¬

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥åˆ†æ­¥æ‰§è¡Œï¼š

### æ­¥éª¤ 1ï¼šåˆ›å»º Users è¡¨

```sql
CREATE TABLE IF NOT EXISTS users (
    openid TEXT PRIMARY KEY,
    last_seen TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_users_last_seen ON users(last_seen DESC);

ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access on users"
    ON users FOR SELECT TO public USING (true);

CREATE POLICY "Allow public insert users"
    ON users FOR INSERT TO public WITH CHECK (true);

CREATE POLICY "Allow users to update own record"
    ON users FOR UPDATE TO public USING (true) WITH CHECK (true);
```

### æ­¥éª¤ 2ï¼šåˆ›å»º Favorites è¡¨

```sql
CREATE TABLE IF NOT EXISTS favorites (
    id BIGSERIAL PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(openid) ON DELETE CASCADE,
    event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, event_id)
);

CREATE INDEX IF NOT EXISTS idx_favorites_user_id ON favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_favorites_event_id ON favorites(event_id);
CREATE INDEX IF NOT EXISTS idx_favorites_created_at ON favorites(created_at DESC);

ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access on favorites"
    ON favorites FOR SELECT TO public USING (true);

CREATE POLICY "Allow public insert favorites"
    ON favorites FOR INSERT TO public WITH CHECK (true);

CREATE POLICY "Allow public delete favorites"
    ON favorites FOR DELETE TO public USING (true);
```

### æ­¥éª¤ 3ï¼šåˆ›å»º View History è¡¨

```sql
CREATE TABLE IF NOT EXISTS view_history (
    id BIGSERIAL PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(openid) ON DELETE CASCADE,
    event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    viewed_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_view_history_user_id ON view_history(user_id);
CREATE INDEX IF NOT EXISTS idx_view_history_viewed_at ON view_history(viewed_at DESC);

ALTER TABLE view_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read own view history"
    ON view_history FOR SELECT TO public USING (true);

CREATE POLICY "Allow public insert view history"
    ON view_history FOR INSERT TO public WITH CHECK (true);
```

### æ­¥éª¤ 4ï¼šåˆ›å»ºè‡ªåŠ¨æ¸…ç†è§¦å‘å™¨

```sql
CREATE OR REPLACE FUNCTION cleanup_old_view_history()
RETURNS TRIGGER AS $$
BEGIN
    DELETE FROM view_history
    WHERE user_id = NEW.user_id
    AND id NOT IN (
        SELECT id FROM view_history
        WHERE user_id = NEW.user_id
        ORDER BY viewed_at DESC
        LIMIT 20
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER cleanup_view_history_trigger
    AFTER INSERT ON view_history
    FOR EACH ROW
    EXECUTE FUNCTION cleanup_old_view_history();
```

---

## âœ… æ‰§è¡ŒæˆåŠŸæ ‡å¿—

æ‰§è¡ŒæˆåŠŸåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

1. **è¡¨åˆ›å»ºæˆåŠŸ**ï¼š4 å¼ è¡¨ï¼ˆevents, users, favorites, view_historyï¼‰
2. **ç´¢å¼•åˆ›å»ºæˆåŠŸ**ï¼šæ¯å¼ è¡¨éƒ½æœ‰ç›¸åº”çš„ç´¢å¼•
3. **RLS ç­–ç•¥åˆ›å»ºæˆåŠŸ**ï¼šæ¯å¼ è¡¨éƒ½æœ‰ç›¸åº”çš„å®‰å…¨ç­–ç•¥
4. **è§¦å‘å™¨åˆ›å»ºæˆåŠŸ**ï¼šview_history è¡¨æœ‰è‡ªåŠ¨æ¸…ç†è§¦å‘å™¨

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Supabaseé›†æˆæŒ‡å—.md](./Supabaseé›†æˆæŒ‡å—.md)
- [Supabaseè¿æ¥æµ‹è¯•æŒ‡å—.md](./Supabaseè¿æ¥æµ‹è¯•æŒ‡å—.md)

---

**æœ€åæ›´æ–°**ï¼š2025å¹´12æœˆ4æ—¥






