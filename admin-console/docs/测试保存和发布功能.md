# 🧪 测试保存草稿和发布功能

## ✅ 数据库权限已配置

根据截图显示，`"Allow anon to insert events"` 策略已经存在，这意味着数据库权限已经配置好了。

---

## 🚀 现在可以测试

### 测试步骤

1. **确保开发服务器正在运行**
   ```bash
   cd admin-console
   npm run dev
   ```

2. **访问 AI 智能采集台**
   - 浏览器打开 http://localhost:3000/ingest
   - 确保已登录

3. **测试保存草稿**
   - 在输入框粘贴一段活动信息（文本、URL 或上传图片）
   - 点击 "AI 识别" 按钮
   - 等待 AI 解析完成
   - 在右侧预览区域确认解析结果
   - 点击 "保存草稿" 按钮
   - ✅ 应该看到 "草稿已保存" 的成功提示

4. **测试发布功能**
   - 在输入框粘贴另一段活动信息
   - 点击 "AI 识别" 按钮
   - 在右侧预览区域确认解析结果
   - 点击 "确认发布" 按钮
   - 在确认对话框中点击 "确定"
   - ✅ 应该看到 "发布成功" 的成功提示

5. **验证数据已保存**
   - 可以在 Supabase Dashboard → Table Editor → events 表中查看
   - 草稿的状态应该是 `inactive`
   - 已发布的状态应该是 `active`

---

## 🔍 如果遇到问题

### 问题 1: "数据库错误: new row violates row-level security policy"

**原因**：RLS 策略配置不正确

**解决方案**：
- 检查 Supabase Dashboard → Authentication → Policies
- 确认 `events` 表有 `"Allow anon to insert events"` 策略
- 如果策略不存在，执行：
  ```sql
  CREATE POLICY "Allow anon to insert events"
      ON events
      FOR INSERT
      TO anon
      WITH CHECK (true);
  ```

### 问题 2: "未授权，请先登录"

**原因**：未登录或 session 过期

**解决方案**：
- 访问 http://localhost:3000/login
- 使用测试账号登录

### 问题 3: "标题和类型为必填字段"

**原因**：AI 解析结果缺少标题或类型

**解决方案**：
- 检查 AI 解析结果
- 在右侧预览区域手动补充标题或类型

---

## 📊 检查数据

### 在 Supabase Dashboard 中查看

1. 打开 Supabase Dashboard
2. 导航到 Table Editor → events
3. 查看最新创建的记录：
   - `status = 'inactive'` → 草稿
   - `status = 'active'` → 已发布
   - `source_group = 'AI 采集'` → 通过 AI 采集台创建

### 使用 SQL 查询

```sql
-- 查看所有草稿
SELECT * FROM events 
WHERE status = 'inactive' 
ORDER BY created_at DESC;

-- 查看所有已发布
SELECT * FROM events 
WHERE status = 'active' 
ORDER BY created_at DESC;

-- 查看通过 AI 采集台创建的内容
SELECT * FROM events 
WHERE source_group = 'AI 采集' 
ORDER BY created_at DESC;
```

---

## ✨ 功能特性

- ✅ **保存草稿**：保存为 `status = 'inactive'`，小程序用户看不到
- ✅ **确认发布**：保存为 `status = 'active'`，小程序用户可以看到
- ✅ **自动记录**：保存原始内容到 `raw_content` 字段
- ✅ **时间戳**：发布时自动设置 `published_at`
- ✅ **来源标记**：自动标记 `source_group = 'AI 采集'`

---

**最后更新**：2025年12月
