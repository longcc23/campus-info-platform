# 🔧 修复活动操作功能

## ❌ 问题

活动列表页面的操作按钮（置顶、发布/下架、删除）不工作。

## 🔍 可能的原因

1. **RLS 权限问题** - UPDATE 和 DELETE 操作需要数据库权限
2. **Service Role Key 未配置** - 如果没有配置，可能受 RLS 限制
3. **API 路由错误** - 检查服务器日志

---

## ✅ 解决方案

### 方案 1: 配置 Service Role Key（推荐）

这是最简单的解决方案，可以绕过所有 RLS 限制。

1. **获取 Service Role Key**
   - Supabase Dashboard → Settings → API
   - 复制 `service_role` key

2. **配置到 `.env.local`**
   ```env
   SUPABASE_SERVICE_ROLE_KEY=你的service_role_key
   ```

3. **重启服务器**
   ```bash
   npm run dev
   ```

4. **验证**
   - 查看服务器控制台，应该看到：`Using Service Role Key (bypasses RLS)`

---

### 方案 2: 配置 RLS 策略（如果不想使用 Service Role Key）

如果使用普通客户端，需要配置 UPDATE 和 DELETE 策略。

#### 步骤

1. **访问 Supabase Dashboard → SQL Editor**

2. **执行以下 SQL**

```sql
-- 允许 anon 角色更新 events 表
CREATE POLICY "Allow anon to update events"
    ON events
    FOR UPDATE
    TO anon
    USING (true)
    WITH CHECK (true);

-- 允许 anon 角色删除 events 表
CREATE POLICY "Allow anon to delete events"
    ON events
    FOR DELETE
    TO anon
    USING (true);
```

3. **如果使用 authenticated 用户，执行**

```sql
-- 允许 authenticated 角色更新
CREATE POLICY "Allow authenticated to update events"
    ON events
    FOR UPDATE
    TO authenticated
    USING (true)
    WITH CHECK (true);

-- 允许 authenticated 角色删除
CREATE POLICY "Allow authenticated to delete events"
    ON events
    FOR DELETE
    TO authenticated
    USING (true);
```

4. **刷新浏览器页面并重试**

---

## 🧪 调试步骤

### 1. 检查浏览器控制台

打开浏览器开发者工具（F12），查看 Console 标签：
- 是否有错误信息？
- 是否有网络请求失败的提示？

### 2. 检查服务器日志

查看运行 `npm run dev` 的终端窗口：
- 是否有错误日志？
- 是否看到 `Using Service Role Key` 或 `Using authenticated client`？

### 3. 测试 API

可以直接测试 API：

```bash
# 测试更新（替换 YOUR_EVENT_ID）
curl -X PATCH http://localhost:3000/api/events/YOUR_EVENT_ID \
  -H "Content-Type: application/json" \
  -d '{"is_top": true}'
```

---

## 📝 当前状态

- ✅ **编辑功能** - 暂时显示提示（功能开发中）
- ✅ **置顶功能** - 已实现，需要配置权限
- ✅ **发布/下架** - 已实现，需要配置权限
- ✅ **删除功能** - 已实现，需要配置权限

所有功能都已添加了详细的错误提示，如果操作失败，会显示具体的错误信息。

---

## 🎯 推荐操作

**最简单的方式**：配置 Service Role Key，这样可以避免所有权限问题。

配置完成后，所有操作功能都应该正常工作了。
